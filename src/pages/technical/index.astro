---
import { type CollectionEntry, getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import Container from "@components/Container.astro";
import ArrowCard from "@components/ArrowCard.astro";
import ShowAll from "@components/ShowAll.astro";
import { BLOG } from "@consts";

const data = (await getCollection("blog"))
  .filter(post => !post.data.draft)
  .filter(post => post.slug.startsWith("technical/"))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// Extract category from slug
const getCategory = (post: CollectionEntry<"blog">) => {
  const parts = post.slug.split("/");
  if (parts.length > 2) {
    const categoryName = parts[1];
    return categoryName.charAt(0).toUpperCase() + categoryName.slice(1).replace(/-/g, " ");
  }
  return "General";
};

// Group posts by category
type CategoryPosts = {
  [category: string]: CollectionEntry<"blog">[];
}

const postsByCategory = data.reduce((acc: CategoryPosts, post) => {
  const category = getCategory(post);
  if (!acc[category]) {
    acc[category] = [];
  }
  acc[category].push(post);
  return acc;
}, {});

// Get top 5 posts per category
const categoriesWithPosts = Object.keys(postsByCategory)
  .sort((a, b) => {
    if (a === "General") return 1;
    if (b === "General") return -1;
    return a.localeCompare(b);
  })
  .map(category => ({
    name: category,
    latestPosts: postsByCategory[category].slice(0, 5),
    allPosts: postsByCategory[category],
    hasMore: postsByCategory[category].length > 5
  }));
---

<PageLayout title={BLOG.TITLE} description={BLOG.DESCRIPTION}>
  <Container>
    <div class="space-y-10">
      <div class="animate font-semibold text-black dark:text-white">
        Technical Writings
      </div>
      <div class="space-y-8">
        {categoriesWithPosts.map(({ name, latestPosts, allPosts, hasMore }) => (
          <section class="animate space-y-4">
            <div class="flex items-center justify-between">
              <div class="font-semibold text-lg text-black dark:text-white border-b border-black/10 dark:border-white/10 pb-2 flex-1">
                {name}
              </div>
              {hasMore && (
                <ShowAll href={`/blog/technical#${name.toLowerCase().replace(/\s+/g, "-")}`}>
                  Show All ({allPosts.length})
                </ShowAll>
              )}
            </div>
            <div>
              <ul class="flex flex-col gap-4">
                {latestPosts.map((post) => (
                  <li>
                    <ArrowCard entry={post}/>
                  </li>
                ))}
              </ul>
            </div>
          </section>
        ))}
      </div>
    </div>
  </Container>
</PageLayout>